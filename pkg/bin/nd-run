#!/usr/bin/env zsh
set -eu -o pipefail

if [[ ${nd:-} == '' ]]; then
    echo "No flake found at $PWD or up." >&2
    exit 1
fi

if [[ $nd == '-' ]]; then
    exec ${@:-zsh}
fi

# TODO maybe there is some nix cli utility to parse this?
if [[ $nd =~ 'path:(.*)' ]]; then
    f=$match[1]
else
    f=$nd
fi

if [[ ! -e $f/.nd/dev ]]; then
    nd-build
fi
exec nix develop $f/.nd/dev --command ${@:-zsh}
